<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kopi Kenangan Senja</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,300;0,400;0,700;1,700&display=swap"
    rel="stylesheet">

  <!-- Feather Icons -->
  <script src="https://unpkg.com/feather-icons"></script>

  <!-- My Style -->
  <link rel="stylesheet" href="css/style.css">
</head>

<body>

  <!-- Navbar start -->
  <nav class="navbar">
    <a href="#" class="navbar-logo">kenangan<span>senja</span>.</a>

    <div class="navbar-nav">
      <a href="#home">Home</a>
      <a href="#about">Tentang Kami</a>
      <a href="#menu">Menu</a>
      <a href="#products">Produk</a>
      <a href="#contact">Kontak</a>
    </div>

    <div class="navbar-extra">
      <a href="#" id="search-button"><i data-feather="search"></i></a>
      <a href="#" id="shopping-cart-button"><i data-feather="shopping-cart"></i></a>
      <a href="#" id="hamburger-menu"><i data-feather="menu"></i></a>
    </div>

    <!-- Search Form start -->
    <div class="search-form">
      <input type="search" id="search-box" placeholder="search here...">
      <label for="search-box"><i data-feather="search"></i></label>
    </div>
    <!-- Search Form end -->

    <!-- Shopping Cart start -->
    <div class="shopping-cart">
      <div class="cart-item">
        <img src="img/products/1.jpg" alt="Product 1">
        <div class="item-detail">
          <h3>Product 1</h3>
          <div class="item-price">IDR 30K</div>
        </div>
        <i data-feather="trash-2" class="remove-item"></i>
      </div>
      <div class="cart-item">
        <img src="img/products/1.jpg" alt="Product 1">
        <div class="item-detail">
          <h3>Product 1</h3>
          <div class="item-price">IDR 30K</div>
        </div>
        <i data-feather="trash-2" class="remove-item"></i>
      </div>
      <div class="cart-item">
        <img src="img/products/1.jpg" alt="Product 1">
        <div class="item-detail">
          <h3>Product 1</h3>
          <div class="item-price">IDR 30K</div>
        </div>
        <i data-feather="trash-2" class="remove-item"></i>
      </div>
    </div>
    <!-- Shopping Cart end -->

  </nav>
  <!-- Navbar end -->

  <!-- Hero Section start -->
  <section class="hero" id="home">
    <div class="mask-container">
      <main class="content">
        <h1>Mari Nikmati Secangkir <span>Kopi</span></h1>
        <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Accusantium, enim.</p>
      </main>
    </div>
  </section>
  <!-- Hero Section end -->

  <!-- About Section start -->
  <section id="about" class="about">
    <h2><span>Tentang</span> Kami</h2>

    <div class="row">
      <div class="about-img">
        <img src="img/tentang-kami.jpg" alt="Tentang Kami">
      </div>
      <div class="content">
        <h3>Kenapa memilih kopi kami?</h3>
        <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Pariatur ducimus voluptatum dolor. Et, voluptatum
          accusantium!</p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Hic deserunt iure amet facilis eos a quo cum
          voluptates molestias nihil.</p>
      </div>
    </div>
  </section>
  <!-- About Section end -->

  <!-- Menu Section start -->
  <section id="menu" class="menu">
    <h2><span>Menu</span> Kami</h2>
    <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Expedita, repellendus numquam quam tempora voluptatum.
    </p>

    <div class="row">
      <div class="menu-card">
        <img src="img/menu/1.jpg" alt="Espresso" class="menu-card-img">
        <h3 class="menu-card-title">- Espresso -</h3>
        <p class="menu-card-price">IDR 15K</p>
      </div>
      <div class="menu-card">
        <img src="img/menu/1.jpg" alt="Espresso" class="menu-card-img">
        <h3 class="menu-card-title">- Capuccino -</h3>
        <p class="menu-card-price">IDR 25K</p>
      </div>
      <div class="menu-card">
        <img src="img/menu/1.jpg" alt="Espresso" class="menu-card-img">
        <h3 class="menu-card-title">- Latte -</h3>
        <p class="menu-card-price">IDR 20K</p>
      </div>
      <div class="menu-card">
        <img src="img/menu/1.jpg" alt="Espresso" class="menu-card-img">
        <h3 class="menu-card-title">- Espresso -</h3>
        <p class="menu-card-price">IDR 15K</p>
      </div>
      <div class="menu-card">
        <img src="img/menu/1.jpg" alt="Espresso" class="menu-card-img">
        <h3 class="menu-card-title">- Espresso -</h3>
        <p class="menu-card-price">IDR 15K</p>
      </div>
      <div class="menu-card">
        <img src="img/menu/1.jpg" alt="Espresso" class="menu-card-img">
        <h3 class="menu-card-title">- Espresso -</h3>
        <p class="menu-card-price">IDR 15K</p>
      </div>
    </div>
  </section>
  <!-- Menu Section end -->

  <!-- Products Section start -->
  <section class="products" id="products">
    <h2><span>Produk Unggulan</span> Kami</h2>
    <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Illo unde eum, ab fuga possimus iste.</p>

    <div class="row">
      <div class="product-card">
        <div class="product-icons">
          <a href="#"><i data-feather="shopping-cart"></i></a>
          <a href="#" class="item-detail-button"><i data-feather="eye"></i></a>
        </div>
        <div class="product-image">
          <img src="img/products/1.jpg" alt="Product 1">
        </div>
        <div class="product-content">
          <h3>Coffee Beans 1</h3>
          <div class="product-stars">
            <i data-feather="star" class="star-full"></i>
            <i data-feather="star" class="star-full"></i>
            <i data-feather="star" class="star-full"></i>
            <i data-feather="star" class="star-full"></i>
            <i data-feather="star"></i>
          </div>
          <div class="product-price">IDR 30K <span>IDR 55K</span></div>
        </div>
      </div>
      <div class="product-card">
        <div class="product-icons">
          <a href="#"><i data-feather="shopping-cart"></i></a>
          <a href="#" class="item-detail-button"><i data-feather="eye"></i></a>
        </div>
        <div class="product-image">
          <img src="img/products/1.jpg" alt="Product 1">
        </div>
        <div class="product-content">
          <h3>Coffee Beans 1</h3>
          <div class="product-stars">
            <i data-feather="star"></i>
            <i data-feather="star"></i>
            <i data-feather="star"></i>
            <i data-feather="star"></i>
            <i data-feather="star"></i>
          </div>
          <div class="product-price">IDR 30K <span>IDR 55K</span></div>
        </div>
      </div>
      <div class="product-card">
        <div class="product-icons">
          <a href="#"><i data-feather="shopping-cart"></i></a>
          <a href="#" class="item-detail-button"><i data-feather="eye"></i></a>
        </div>
        <div class="product-image">
          <img src="img/products/1.jpg" alt="Product 1">
        </div>
        <div class="product-content">
          <h3>Coffee Beans 1</h3>
          <div class="product-stars">
            <i data-feather="star"></i>
            <i data-feather="star"></i>
            <i data-feather="star"></i>
            <i data-feather="star"></i>
            <i data-feather="star"></i>
          </div>
          <div class="product-price">IDR 30K <span>IDR 55K</span></div>
        </div>
      </div>
    </div>
  </section>
  <!-- Products Section end -->

  <!-- Contact Section start -->
  <section id="contact" class="contact">
    <h2><span>Kontak</span> Kami</h2>
    <p id="contact-desc">Hubungi kami untuk informasi lebih lanjut atau kunjungi lokasi kami.</p>

    <div class="contact-info" id="contact-info">
      <!-- Filled dynamically from settings -->
    </div>

    <div class="row">
      <iframe
        src="about:blank"
        allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade" class="map"></iframe>

      <form id="contact-form" onsubmit="return false;">
        <div class="input-group">
          <i data-feather="message-square"></i>
          <textarea id="contact-message" placeholder="Tulis pesan untuk dikirim via WhatsApp" rows="3"></textarea>
        </div>
        <button type="button" class="btn" id="contact-wa-btn">Kirim ke WhatsApp</button>
      </form>

    </div>
  </section>
  <!-- Contact Section end -->

  <!-- Footer start -->
  <footer>
    <div class="socials">
      <a href="#"><i data-feather="instagram"></i></a>
      <a href="#"><i data-feather="twitter"></i></a>
      <a href="#"><i data-feather="facebook"></i></a>
    </div>

    <div class="links">
      <a href="#home">Home</a>
      <a href="#about">Tentang Kami</a>
      <a href="#menu">Menu</a>
      <a href="#contact">Kontak</a>
    </div>

    <div class="credit">
      <p>Created by <a href="">sandhikagalih</a>. | &copy; 2023.</p>
    </div>
  </footer>
  <!-- Footer end -->

  <!-- Modal Box Item Detail start -->
  <div class="modal" id="item-detail-modal">
    <div class="modal-container">
      <a href="#" class="close-icon"><i data-feather="x"></i></a>
      <div class="modal-content">
        <img src="img/products/1.jpg" alt="Product 1">
        <div class="product-content">
          <h3>Product 1</h3>
          <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Provident, tenetur cupiditate facilis obcaecati
            ullam maiores minima quos perspiciatis similique itaque, esse rerum eius repellendus voluptatibus!</p>
          <div class="product-stars">
            <i data-feather="star" class="star-full"></i>
            <i data-feather="star" class="star-full"></i>
            <i data-feather="star" class="star-full"></i>
            <i data-feather="star" class="star-full"></i>
            <i data-feather="star"></i>
          </div>
          <div class="product-price">IDR 30K <span>IDR 55K</span></div>
          <a href="#"><i data-feather="shopping-cart"></i> <span>add to cart</span></a>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal Box Item Detail end -->

  <!-- Feather Icons -->
  <script>
    feather.replace()
  </script>

  <!-- My Javascript -->
  <script src="js/script.js"></script>
  <script src="js/auth-ui.js"></script>
  <script type="module" src="js/cart.js"></script>
  <script>
    // Dynamically load menu/products from API with graceful fallback
    (function(){
      const API_BASE = (function(){
        // Support sharing a single ngrok link that auto-configures the API base.
        // Example: https://<web>.ngrok-free.app/index.html?api=https://<api>.ngrok-free.app
        try{
          const params = new URLSearchParams(location.search || '');
          const fromQuery = params.get('api') || params.get('api_base') || params.get('kk_api_base');
          if(fromQuery && /^https?:\/\//i.test(fromQuery)){
            localStorage.setItem('kk_api_base', fromQuery.replace(/\/$/, ''));
          }
        }catch(_e){}

        try{ const stored = localStorage.getItem('kk_api_base'); if(stored) return stored; }catch(_e){}

        const isNgrokHost = /(^|\.)ngrok(-free)?\.app$/i.test(location.hostname) || /(^|\.)ngrok\.io$/i.test(location.hostname);
        if(isNgrokHost){
          console.warn('Ngrok detected but kk_api_base is not set. Add ?api=https://<api-ngrok> or set localStorage.kk_api_base to your API tunnel URL.');
          return location.origin;
        }

        const host = location.hostname || '127.0.0.1';
        const isPrivateHost = host==='localhost' || host==='127.0.0.1' || /^10\./.test(host) || /^192\.168\./.test(host) || /^172\.(1[6-9]|2\d|3[0-1])\./.test(host);
        const hasHttpOrigin = location.origin && !location.origin.startsWith('file://');
        if(hasHttpOrigin){
          if(isPrivateHost && location.port && location.port !== '8000') return `http://${host}:8000`;
          return location.origin;
        }
        return `http://${host}:8000`;
      })();
      const user = (function(){ try { return JSON.parse(localStorage.getItem('kk_user')||'null'); } catch(_e){ return null; } })();
      const role = (user && typeof user.role === 'string') ? user.role.toLowerCase() : '';
      const isAdmin = role === 'admin';
      const menuRow = document.querySelector('#menu .row');
      const prodRow = document.querySelector('#products .row');
      function formatPrice(p){return 'IDR ' + Math.round(Number(p||0)/1000)+'K'}
      function card(item){
        const img = item.image_url || item.img || 'img/menu/1.jpg';
        const name = item.name || 'Tanpa Nama';
        const price = formatPrice(item.price||0);
        const targetId = item.id || '';
        const adminControls = isAdmin ? `
          <div class="menu-admin-controls" title="Kelola menu">
            <button class="admin-manage" data-admin-edit="${targetId}" aria-label="Kelola menu"><i data-feather="edit-3"></i></button>
          </div>` : '';
        return `
          <div class="menu-card">
            ${adminControls}
            <img src="${img}" alt="${name}" class="menu-card-img">
            <h3 class="menu-card-title">- ${name} -</h3>
            <p class="menu-card-price">${price}</p>
          </div>`;
      }
      function productCard(item){
        const img = item.image_url || item.img || 'img/products/1.jpg';
        const name = item.name || 'Produk';
        const price = formatPrice(item.price||0);
        const targetId = item.id || '';
  const adminControls = isAdmin ? `<button class="admin-manage" data-admin-edit="${targetId}" title="Kelola produk" aria-label="Kelola produk"><i data-feather="edit-3"></i></button>` : '';
      function bindAdminLinks(){
        if(!isAdmin) return;
        document.querySelectorAll('[data-admin-edit]').forEach(btn=>{
          if(btn.dataset.bound === '1') return;
          btn.dataset.bound = '1';
          btn.addEventListener('click', e=>{
            e.preventDefault();
            const id = btn.getAttribute('data-admin-edit');
            const url = id ? `admin-menu.html?focus=${encodeURIComponent(id)}` : 'admin-menu.html';
            window.location.href = url;
          });
        });
      }
        return `
        <div class="product-card">
          <div class="product-icons">
            ${adminControls}
            <a href="#" class="add-cart" data-id="${item.id}" data-name="${name}" data-price="${item.price||0}"><i data-feather="shopping-cart"></i></a>
            <a href="coffee.html?id=${encodeURIComponent(item.id||'')}" class="item-detail-button"><i data-feather="eye"></i></a>
          </div>
          <div class="product-image">
            <img src="${img}" alt="${name}">
          </div>
          <div class="product-content">
            <h3>${name}</h3>
            <div class="product-stars">
              <i data-feather="star" class="star-full"></i>
              <i data-feather="star" class="star-full"></i>
              <i data-feather="star" class="star-full"></i>
              <i data-feather="star" class="star-full"></i>
              <i data-feather="star"></i>
            </div>
            <div class="product-price">${price} <span></span></div>
          </div>
        </div>`;
      }
      async function load(){
        try {
          const r = await fetch(`${API_BASE}/api/products?active=true`);
          if(!r.ok) throw new Error('http '+r.status);
          const data = await r.json();
          if(menuRow) menuRow.innerHTML = data.map(card).join('');
          if(prodRow) prodRow.innerHTML = data.map(productCard).join('');
          if(window.feather) feather.replace();
          bindCartButtons();
          bindAdminLinks();
        } catch(_e){
          // keep static content as fallback
        }
        // Load map and contact info
        loadMapUrl();
        loadContactInfo();
      }
      
      async function loadMapUrl(){
        try {
          const res = await fetch(`${API_BASE}/api/settings/site_profile`);
          if(!res.ok) {
            console.log('Map URL: API response not ok', res.status);
            return;
          }
          const data = await res.json();
          console.log('Map URL data:', data);
          if(data && data.value && data.value.mapUrl){
            const mapIframe = document.querySelector('.contact .map');
            console.log('Map iframe element:', mapIframe);
            console.log('New map URL:', data.value.mapUrl);
            if(mapIframe) {
              mapIframe.src = data.value.mapUrl;
              console.log('Map URL updated successfully');
            } else {
              console.log('Map iframe not found');
            }
          } else {
            console.log('No mapUrl in data');
          }
        } catch(e){
          console.error('Error loading map URL:', e);
        }
      }

      async function loadContactInfo(){
        try {
          const res = await fetch(`${API_BASE}/api/settings/site_profile`);
          if(!res.ok) return;
          const data = await res.json();
          const profile = (data && data.value) || {};
          const infoEl = document.getElementById('contact-info');
          const descEl = document.getElementById('contact-desc');
          const waBtn = document.getElementById('contact-wa-btn');
          const msgInput = document.getElementById('contact-message');
          if(descEl){
            descEl.textContent = profile.address ? `Kunjungi kami di ${profile.address} atau hubungi kontak berikut.` : 'Hubungi kami untuk informasi lebih lanjut atau kunjungi lokasi kami.';
          }
          if(!infoEl) return;
          const items = [
            {icon:'phone', label:'Telepon', value: profile.phone},
            {icon:'mail', label:'Email', value: profile.email},
            {icon:'message-circle', label:'WhatsApp', value: profile.whatsapp},
            {icon:'map-pin', label:'Alamat', value: profile.address}
          ].filter(i=>i.value);
          if(items.length===0){
            infoEl.innerHTML = '<div class="info-item">Kontak belum disetel admin.</div>';
          } else {
            infoEl.innerHTML = items.map(i=>`
              <div class="info-item">
                <i data-feather="${i.icon}"></i>
                <div>
                  <strong>${i.label}</strong>
                  <span>${i.value}</span>
                </div>
              </div>
            `).join('');
            if(window.feather) feather.replace();
          }

          // Bind WhatsApp send
          if(waBtn){
            const waNumber = (profile.whatsapp || '').replace(/[^\d]/g,'');
            waBtn.onclick = ()=>{
              const msg = (msgInput && msgInput.value.trim()) || 'Halo, saya ingin bertanya tentang produk.';
              if(!waNumber){
                alert('Nomor WhatsApp belum disetel admin.');
                return;
              }
              const url = `https://wa.me/${waNumber}?text=${encodeURIComponent(msg)}`;
              window.open(url, '_blank');
            };
          }
        } catch(_e){
          // keep fallback text
        }
      }
      function bindCartButtons(){
        document.querySelectorAll('.add-cart').forEach(btn=>{
          btn.addEventListener('click', e=>{
            e.preventDefault();
            import('./js/cart.js').then(m=>{
              m.addToCart(btn.getAttribute('data-id'), btn.getAttribute('data-name'), Number(btn.getAttribute('data-price')), 1);
            });
          });
        });
        bindAdminLinks();
      }
      function ensureAdminFab(){
        if(!isAdmin) return;
        if(document.querySelector('.admin-fab')) return;
        const fab = document.createElement('a');
        fab.href = 'admin-menu.html';
        fab.className = 'admin-fab';
        fab.setAttribute('title','Kelola menu');
        fab.setAttribute('aria-label','Kelola menu');
        fab.innerHTML = '<i data-feather="plus"></i><span>Kelola Produk</span>';
        document.body.appendChild(fab);
        if(window.feather) feather.replace();
      }
      ensureAdminFab();
      load();
    })();
  </script>
</body>

</html>