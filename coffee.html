<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detail Kopi</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    body.lux-bg{background:linear-gradient(115deg,rgba(var(--primary-rgb),0.25),transparent 38%),var(--bg);}
    .coffee-wrap{max-width:1060px;margin:6.2rem auto 4rem;padding:1.2rem 1.4rem}
    .coffee-card{position:relative;background:linear-gradient(140deg,var(--card),rgba(var(--primary-rgb),0.08));border:1px solid rgba(var(--primary-rgb),0.20);border-radius:24px;box-shadow:0 18px 42px -8px rgba(var(--primary-rgb),0.25),0 6px 18px rgba(0,0,0,0.08);padding:2rem;display:grid;grid-template-columns:360px 1fr;gap:2rem;overflow:hidden}
    .coffee-card::before{content:"";position:absolute;inset:0;background:radial-gradient(circle at 25% 20%,rgba(var(--primary-rgb),0.18),transparent 60%);pointer-events:none;opacity:.6}
    .coffee-img-wrap{position:relative}
    .coffee-img{width:100%;height:340px;object-fit:cover;border-radius:20px;box-shadow:0 10px 28px -6px rgba(0,0,0,.25)}
  .coffee-meta h2{margin:0 0 .6rem;font-size:2.2rem;letter-spacing:.5px;line-height:1.15;background:linear-gradient(90deg,var(--primary),#c69a6d);-webkit-background-clip:text;background-clip:text;color:transparent}
  .coffee-meta .price{display:inline-block;background:rgba(var(--primary-rgb),0.12);color:var(--primary);font-weight:600;margin:.2rem 0 1.2rem;padding:.5rem 1rem;border-radius:30px;font-size:1rem;-webkit-backdrop-filter:blur(3px);backdrop-filter:blur(3px)}
    .coffee-desc{font-size:1rem;line-height:1.55;color:var(--text);margin-bottom:1.4rem;max-width:640px}
    .coffee-desc strong{color:var(--primary)}
    .coffee-tags{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1.4rem}
    .coffee-tag{background:rgba(var(--primary-rgb),0.10);color:var(--primary);padding:.45rem .9rem;font-size:.72rem;border-radius:18px;letter-spacing:.5px;font-weight:500;text-transform:uppercase}
    .coffee-form{margin-top:1.2rem;background:var(--bg-alt);padding:1.1rem 1.1rem 1.4rem;border-radius:18px;border:1px solid rgba(var(--primary-rgb),0.18)}
    .coffee-form label{display:block;font-size:.78rem;color:var(--muted);margin:.45rem 0 .3rem}
    .coffee-form input[type="text"], .coffee-form input[type="number"]{width:100%;padding:.65rem .75rem;border:1px solid rgba(0,0,0,.14);border-radius:10px;background:var(--card);box-shadow:var(--shadow-sm)}
    .coffee-form input[type="file"]{margin-top:.35rem}
    .coffee-actions{margin-top:1.1rem;display:flex;flex-wrap:wrap;gap:.6rem}
    .danger{background:var(--danger)}
    .back-link{display:inline-flex;align-items:center;gap:.4rem;margin-bottom:1.2rem;font-size:.9rem;color:var(--primary);text-decoration:none}
    .back-link:hover{opacity:.8}
    @media (max-width:980px){.coffee-card{grid-template-columns:1fr;padding:1.6rem}.coffee-img{height:300px}}
    @media (max-width:640px){.coffee-meta h2{font-size:1.8rem}.coffee-img{height:260px}}
  </style>
  <script>
    function q(k){return new URLSearchParams(location.search).get(k)}
  </script>
</head>
<body>
  <nav class="navbar">
    <a href="index.html" class="navbar-logo">kenangan<span>senja</span>.</a>
    <div class="navbar-extra">
      <a href="dashboard.html">Dashboard</a>
      <a href="#" id="theme-toggle" title="Tema">Tema</a>
    </div>
  </nav>

  <main class="coffee-wrap">
    <div id="not-found" class="hidden">Item tidak ditemukan.</div>
    <div id="coffee-card" class="coffee-card hidden">
      <div class="coffee-img-wrap">
        <img id="coffee-img" class="coffee-img" src="" alt="Coffee Terpilih" />
      </div>
      <div class="coffee-meta">
        <a href="index.html" class="back-link" aria-label="Kembali"><i data-feather="arrow-left"></i>Kembali</a>
        <h2 id="coffee-name"></h2>
        <div class="price" id="coffee-price"></div>
        <div class="coffee-desc" id="coffee-desc"></div>
        <div class="coffee-tags" id="coffee-tags"></div>
        <!-- Order Box for members: choose quantity and add to cart -->
        <div id="order-box" class="coffee-form">
          <label for="order-qty">Jumlah</label>
          <input id="order-qty" type="number" min="1" value="1" />
          <div class="order-total">Total: <strong id="order-total">IDR 0K</strong></div>
          <div class="coffee-actions">
            <button id="btn-order-add" class="btn">Tambah ke Keranjang</button>
          </div>
        </div>
        <div id="admin-tools" class="coffee-form hidden">
          <label>Nama</label>
          <label for="f-name">Nama Kopi</label>
          <input id="f-name" type="text" placeholder="Nama kopi" />
          <label>Harga (contoh 15000)</label>
          <label for="f-price">Harga (Rp)</label>
          <input id="f-price" type="number" placeholder="Contoh 15000" />
          <label>Gambar (upload dari komputer)</label>
          <label for="f-file">Ganti Gambar</label>
          <input id="f-file" type="file" accept="image/*" />
          <div class="coffee-actions">
            <button id="btn-save" class="btn">Simpan Perubahan</button>
            <button id="btn-delete" class="btn danger">Hapus Item</button>
          </div>
          <small class="muted-note">Catatan: Gambar disimpan lokal (localStorage) sebagai Data URL untuk demo tanpa server.</small>
        </div>
      </div>
    </div>
  </main>

        <script src="js/auth-ui.js"></script>
        <script>
          (function(){
            'use strict';

            function applyTheme(theme){
              document.documentElement.setAttribute('data-theme', theme);
              localStorage.setItem('kk_theme', theme);
            }
            (function initTheme(){
              const saved = localStorage.getItem('kk_theme') || 'light';
              applyTheme(saved);
              const toggle = document.getElementById('theme-toggle');
              if(toggle){
                toggle.addEventListener('click', e=>{
                  e.preventDefault();
                  const current = document.documentElement.getAttribute('data-theme') || 'light';
                  applyTheme(current === 'light' ? 'dark' : 'light');
                });
              }
            })();

            document.body.classList.add('lux-bg');

            const API_BASE = (function(){
              try{ const stored = localStorage.getItem('kk_api_base'); if(stored) return stored; }catch(_e){}
              const host = location.hostname || '127.0.0.1';
              const isPrivateHost = host==='localhost' || host==='127.0.0.1' || /^10\./.test(host) || /^192\.168\./.test(host) || /^172\.(1[6-9]|2\d|3[0-1])\./.test(host);
              const hasHttpOrigin = location.origin && !location.origin.startsWith('file://');
              if(hasHttpOrigin){
                if(isPrivateHost && location.port && location.port !== '8000') return `http://${host}:8000`;
                return location.origin;
              }
              return `http://${host}:8000`;
            })();

        const id = q('id');
        const user = JSON.parse(localStorage.getItem('kk_user') || 'null');
        const role = (user && typeof user.role === 'string') ? user.role.toLowerCase() : '';
        const isAdmin = role === 'admin';
        const isMember = role === 'member';
            let currentItem = null;
            let uploadedDataUrl = null;

            function formatPrice(p){
              return 'IDR ' + Math.round(Number(p || 0) / 1000) + 'K';
            }

            function getItems(){
              try {
                return JSON.parse(localStorage.getItem('kk_menu_items') || '[]');
              } catch(_e){
                return [];
              }
            }
            function findItemLocal(){
              return getItems().find(i=> String(i.id) === String(id));
            }

            function updateOrderTotal(){
              const qtyEl = document.getElementById('order-qty');
              const totalEl = document.getElementById('order-total');
              if(!qtyEl || !totalEl) return;
              let qty = Number(qtyEl.value || 1);
              if(!Number.isFinite(qty) || qty < 1) qty = 1;
              qtyEl.value = qty;
              const total = (currentItem?.price || 0) * qty;
              totalEl.textContent = formatPrice(total);
            }

            function makeDescription(name){
              const base = 'Kopi pilihan dengan karakter rasa yang seimbang.';
              const n = (name || '').toLowerCase();
              if(n.includes('espresso')) return 'Ekstraksi murni yang <strong>tebal</strong> dengan lapisan crema halus dan aftertaste karamel.';
              if(n.includes('latte')) return 'Perpaduan espresso lembut dan susu creamy menciptakan tekstur <strong>velvet</strong> yang menenangkan.';
              if(n.includes('capp')) return 'Balutan foam ringan di atas espresso aromatik menghadirkan sensasi <strong>airy</strong> dan sedikit manis alami.';
              if(n.includes('mocha')) return 'Kombinasi cokelat dan espresso yang <strong>rich</strong> untuk pencinta rasa manis berkelas.';
              return base;
            }

            function tagSuggestions(name){
              const tags = ['AROMATIC', 'FRESH ROAST', 'SPECIALTY'];
              const n = (name || '').toLowerCase();
              if(n.includes('espresso')) tags.push('STRONG');
              if(n.includes('latte')) tags.push('MILKY');
              if(n.includes('capp')) tags.push('FOAMY');
              if(n.includes('mocha')) tags.push('CHOCOLATE');
              return tags;
            }

            async function fetchDetail(){
              if(!id) return null;
              try {
                const r = await fetch(`${API_BASE}/api/products/${encodeURIComponent(id)}`);
                if(!r.ok) throw new Error('http ' + r.status);
                const data = await r.json();
                return {
                  id: data.id,
                  name: data.name,
                  price: data.price,
                  img: (data.images && data.images[0]?.image_url) || 'img/menu/1.jpg',
                  description: data.description
                };
              } catch(_e){
                return findItemLocal() || null;
              }
            }

            async function render(){
              const item = await fetchDetail();
              const nf = document.getElementById('not-found');
              const card = document.getElementById('coffee-card');
              if(!item){
                nf.classList.remove('hidden');
                card.classList.add('hidden');
                return;
              }

              nf.classList.add('hidden');
              card.classList.remove('hidden');

              document.getElementById('coffee-img').src = item.img || 'img/menu/1.jpg';
              document.getElementById('coffee-name').textContent = item.name || 'Tanpa Nama';
              document.getElementById('coffee-price').textContent = formatPrice(item.price);

              const desc = document.getElementById('coffee-desc');
              if(desc){
                desc.innerHTML = (item.description && item.description.trim()) || makeDescription(item.name || '');
              }

              const tagsEl = document.getElementById('coffee-tags');
              if(tagsEl){
                tagsEl.innerHTML = tagSuggestions(item.name || '').map(t=>`<span class="coffee-tag">${t}</span>`).join('');
              }

              currentItem = item;
              updateOrderTotal();

              const admin = isAdmin;
              const tools = document.getElementById('admin-tools');
              if(tools){
                if(admin){
                  tools.classList.remove('hidden');
                  const nameField = document.getElementById('f-name');
                  const priceField = document.getElementById('f-price');
                  if(nameField) nameField.value = item.name || '';
                  if(priceField) priceField.value = Number(item.price || 0);
                } else {
                  tools.classList.add('hidden');
                }
              }

              const orderBox = document.getElementById('order-box');
              if(orderBox){
                if(isMember || !user){
                  orderBox.classList.remove('hidden');
                } else {
                  orderBox.classList.add('hidden');
                }
              }

              if(window.feather){
                feather.replace();
              }
            }

            const qtyInput = document.getElementById('order-qty');
            if(qtyInput){
              qtyInput.addEventListener('input', updateOrderTotal);
              qtyInput.addEventListener('change', updateOrderTotal);
            }

            const addBtn = document.getElementById('btn-order-add');
            if(addBtn){
              addBtn.addEventListener('click', async function(){
                if(!currentItem){
                  return;
                }
                const qty = Math.max(1, Number((document.getElementById('order-qty') || {}).value || 1));
                try {
                  const mod = await import('./js/cart.js');
                  await mod.addToCart(currentItem.id, currentItem.name, Number(currentItem.price || 0), qty);
                  alert('Ditambahkan ke keranjang.');
                } catch(err){
                  alert('Gagal menambahkan ke keranjang: ' + err.message);
                }
              });
            }

        const MAX_FILE_SIZE = 1024 * 1024; // 1MB
            const COMPRESS_THRESHOLD = 300 * 1024; // 300KB

            function compressImage(file, maxWidth = 700, quality = 0.85){
              return new Promise((resolve, reject)=>{
                const img = new Image();
                const rd = new FileReader();
                rd.onload = ev=>{
                  img.onload = ()=>{
                    try {
                      const c = document.createElement('canvas');
                      const scale = Math.min(1, maxWidth / img.width);
                      c.width = Math.round(img.width * scale);
                      c.height = Math.round(img.height * scale);
                      const ctx = c.getContext('2d');
                      ctx.drawImage(img, 0, 0, c.width, c.height);
                      const data = c.toDataURL('image/jpeg', quality);
                      resolve(data);
                    } catch(err){
                      reject(err);
                    }
                  };
                  img.onerror = ()=>reject(new Error('Gagal memuat gambar.'));
                  img.src = ev.target.result;
                };
                rd.onerror = ()=>reject(new Error('Gagal membaca file.'));
                rd.readAsDataURL(file);
              });
            }

            const fileInput = document.getElementById('f-file');
            let selectedFile = null; // store original File for upload
            if(fileInput){
              fileInput.addEventListener('change', async function(e){
                const file = e.target.files && e.target.files[0];
                selectedFile = file || null; // store for later upload
                if(!file){
                  uploadedDataUrl = null;
                  selectedFile = null;
                  return;
                }
                if(!file.type.startsWith('image/')){
                  alert('File harus gambar.');
                  e.target.value = '';
                  selectedFile = null;
                  return;
                }
                if(file.size > MAX_FILE_SIZE){
                  alert('Ukuran maks 1MB.');
                  e.target.value = '';
                  selectedFile = null;
                  return;
                }
                try {
                  if(file.size > COMPRESS_THRESHOLD){
                    uploadedDataUrl = await compressImage(file);
                  } else {
                    uploadedDataUrl = await new Promise((resolve, reject)=>{
                      const reader = new FileReader();
                      reader.onload = ev=>resolve(ev.target.result);
                      reader.onerror = ()=>reject(new Error('Gagal membaca file.'));
                      reader.readAsDataURL(file);
                    });
                  }
                  const imgEl = document.getElementById('coffee-img');
                  if(imgEl){
                    imgEl.src = uploadedDataUrl;
                  }
                } catch(err){
                  alert('Gagal memproses gambar: ' + err.message);
                  uploadedDataUrl = null;
                  selectedFile = null;
                }
              });
            }

            const saveBtn = document.getElementById('btn-save');
            if(saveBtn){
              saveBtn.addEventListener('click', async function(){
                if(!isAdmin){
                  alert('Hanya admin.');
                  return;
                }
                const token = user && user.token;
                const nameField = document.getElementById('f-name');
                const priceField = document.getElementById('f-price');
                const newName = nameField ? nameField.value.trim() : '';
                const newPrice = priceField ? Number(priceField.value || 0) : 0;
                try {
                  // Update product name & price
                  const res = await fetch(`${API_BASE}/api/products/${encodeURIComponent(id)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ name: newName, price: newPrice })
                  });
                  if(!res.ok){
                    throw new Error('Gagal menyimpan. Kode: ' + res.status);
                  }

                  // Upload image if admin selected a file
                  if(selectedFile){
                    const fd = new FormData();
                    fd.append('file', selectedFile, selectedFile.name);
                    const imgRes = await fetch(`${API_BASE}/api/products/${encodeURIComponent(id)}/images`, {
                      method: 'POST',
                      headers: { 'Authorization': `Bearer ${token}` },
                      body: fd
                    });
                    if(!imgRes.ok){
                      console.warn('Upload gambar gagal', imgRes.status);
                      // not fatal â€” product already saved
                    } else {
                      selectedFile = null;
                      uploadedDataUrl = null;
                    }
                  }

                  alert('Tersimpan.');
                  render();
                } catch(err){
                  alert(err.message);
                }
              });
            }

            const deleteBtn = document.getElementById('btn-delete');
            if(deleteBtn){
              deleteBtn.addEventListener('click', async function(){
                if(!isAdmin){
                  alert('Hanya admin.');
                  return;
                }
                if(!confirm('Hapus item ini?')) return;
                const token = user && user.token;
                try {
                  const res = await fetch(`${API_BASE}/api/products/${encodeURIComponent(id)}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                  });
                  if(!res.ok){
                    throw new Error('Gagal menghapus. Kode: ' + res.status);
                  }
                  alert('Item dihapus.');
                  location.href = 'index.html';
                } catch(err){
                  alert(err.message);
                }
              });
            }

            render();
            window.addEventListener('storage', ()=>{ render(); });
          })();
        </script>
</body>
</html>